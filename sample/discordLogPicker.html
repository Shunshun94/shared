<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Discord Log Picker</title>
</head>
<body>
<pre id="console"></pre>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://shunshun94.github.io/shared/jquery/com/hiyoko/util/v2/utils.js"></script>
<script src="../external/discord.io/index.js"></script>
<script src="../other/io/github/shunshun94/trpg/clientSpec.js"></script>
<script src="../other/io/github/shunshun94/trpg/discord/client.js"></script>
<script>
const query = com.hiyoko.util.getQueries();
let tokenList = JSON.parse(localStorage.getItem('io-github-shunshun94-trpg-discord-Entrance-Token-TokenList') || '[null]');
const token = query.token || query.url || prompt("Discord Bot の Token を入力してください", localStorage.getItem('io-github-shunshun94-trpg-discord-entry-token') || tokenList.reverse()[0] || '');
const room = query.room || query.channel || prompt("Discord の channel ID を入力してください\nChannel の URL が https://discordapp.com/channels/000000000000000000/463088764508438539 なら最後の 463088764508438539");
const fromId = query.fromId || prompt("Discord の発言 ID を入力してください。\n入力された ID より後の発言を取得します (入力された発言は取得されません)\nチャネルの発言を最初から取得する場合は 1 を入力してください", "1") || 1;
const discordClient = new io.github.shunshun94.trpg.discord.Room(token, room);
const $console = $('#console');


const getLogRecursive = (client, lastId=1, currentArray=[], retryCount=0, maxRetry=5)=>{
	const nextRetryCount = retryCount + 1;
	$console.html(`${$console.html()}MSGID ${lastId} から100件のメッセージを取得中 (${nextRetryCount}回目の取得試行)<br/>`);
	return new Promise((resolve, reject)=>{
		client.getChat(lastId).then((result)=>{
			if(result.result === 'OK') {
				if(result.chatMessageDataLog.length) {
					const nextLastId = result.chatMessageDataLog.reverse()[0][1].uniqueId;
					getLogRecursive(client, nextLastId, currentArray.concat(result.chatMessageDataLog.reverse()), 0, maxRetry).then((result)=>{
						resolve(result);
					}, (err, a, b, c, d, e)=>{
						reject(err, a, b, c, d, e);
					});
				} else {
					$console.html(`${$console.html()}取得完了! (全${currentArray.length}件)<br/>`);
					resolve(currentArray);
				}
			} else {
				if(nextRetryCount >= maxRetry) {
					reject(err, client, lastId, currentArray, retryCount, maxRetry);
				}				
				getLogRecursive(client, lastId, currentArray, retryCount + 1, maxRetry).then((result)=>{
					resolve(result);
				}, (err, a, b, c, d, e)=>{
					reject(err, a, b, c, d, e);
				});
			}
		}, (err)=>{
			if(nextRetryCount >= maxRetry) {
				reject(err, client, lastId, currentArray, retryCount, maxRetry);
			}
			getLogRecursive(client, lastId, currentArray, retryCount + 1, maxRetry).then((result)=>{
				resolve(result);
			}, (err, a, b, c, d, e)=>{
				reject(err, a, b, c, d, e);
			});			
		});
	});
};

const generateUrl = (data, donwloadText="DOWNLOAD") => {
	const blob = new Blob([ data ], { "type" : "text/plain" });
	const url = window.URL.createObjectURL(blob);
	const $a = $('<a></a>');
	$a.text(donwloadText);
	$a.attr('href', url);
	$console.append($a);
	$console.append('<br/>');
}

const htmlConverterHiyoAppRegExp = /^([^:]+): /;
const htmlConverterParenthesisRegExp = /^([^「]+)「/;
const convertMsgToHiyoHtml = (msg)=>{
	const appRegExpResult = htmlConverterHiyoAppRegExp.exec(msg[1].message);
	const preRegExpResult = htmlConverterParenthesisRegExp.exec(msg[1].message);
	const time = new Date(msg[0]);
	if(appRegExpResult) {
		const name = appRegExpResult[1];
		let clazz = '_';
		for(var i = 0; i < name.length; i++) {
			clazz += String(name.charCodeAt(i));
		}
		return `<p class="tab0 _${msg[1].metadata.senderId} ${clazz}">
		<span class="time"><span class="unixTime">${msg[0]}</span>
		<span class="redableTime">${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}:${String(time.getSeconds()).padStart(2, '0')}</span></span>
		<span class="name">${name}<!-- ${msg[1].senderName} --></span>
		<span class="message">${msg[1].message.replace(appRegExpResult[0], '').replace(/\n/gm, '<br/>\n')}</span></p>`
	} else if(preRegExpResult) {
		const name = preRegExpResult[1];
		let clazz = '_';
		for(var i = 0; i < name.length; i++) {
			clazz += String(name.charCodeAt(i));
		}
		return `<p class="tab0 _${msg[1].metadata.senderId} ${clazz}">
		<span class="time"><span class="unixTime">${msg[0]}</span>
		<span class="redableTime">${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}:${String(time.getSeconds()).padStart(2, '0')}</span></span>
		<span class="name">${name}<!-- ${msg[1].senderName} --></span>
		<span class="message">「${msg[1].message.replace(preRegExpResult[0], '').replace(/\n/gm, '<br/>\n')}</span></p>`
	} else {
		return `<p class="tab0 _${msg[1].metadata.senderId}">
		<span class="time"><span class="unixTime">${msg[0]}</span>
		<span class="redableTime">${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}:${String(time.getSeconds()).padStart(2, '0')}</span></span>
		<span class="name">${msg[1].senderName}</span>
		<span class="message">${msg[1].message.replace(/\n/gm, '<br/>\n')}</span></p>`
	}
};

setTimeout(()=>{
	getLogRecursive(discordClient, fromId).then((result)=>{
		generateUrl(JSON.stringify(result), 'JSON ファイルとしてダウンロードする');
		
		const html = 	'<html><head><link rel="stylesheet" href="https://shunshun94.github.io/shared/jquery/io/github/shunshun94/trpg/replay/replay4.css" type="text/css" /></head>\n<body>\n' +
									result.map((d)=>{
										return convertMsgToHiyoHtml(d);
									}).join('\n') +
									'\n</body></html>';
		generateUrl(html, 'HTML ファイルとしてダウンロードする');
	}, (err, a, b, c, d, e) => {
		$console.append(`<p>${JSON.stringify(err)}</p>`);
		console.error(err, a, b, c, d, e);
	});
}, 3000);
</script>

</body>
</html>